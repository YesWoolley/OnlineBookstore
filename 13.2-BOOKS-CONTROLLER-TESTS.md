# Books Controller Tests

This document provides comprehensive unit tests for the `BooksController` in the Online Bookstore application.

## Test Structure

### Test Class Setup
```csharp
public class BooksControllerTests
{
    private readonly Mock<IBookService> _mockBookService;
    private readonly BooksController _controller;

    public BooksControllerTests()
    {
        _mockBookService = new Mock<IBookService>();
        _controller = new BooksController(_mockBookService.Object);
    }
}
```

## Test Categories

### 1. GET Operations

#### GetBooks_ReturnsOkResult_WithBooksList
```csharp
[Fact]
public async Task GetBooks_ReturnsOkResult_WithBooksList()
{
    // Arrange
    var books = new List<BookDto>
    {
        TestHelpers.CreateTestBookDto(1),
        TestHelpers.CreateTestBookDto(2)
    };
    _mockBookService.Setup(x => x.GetAllBooksAsync()).ReturnsAsync(books);

    // Act
    var result = await _controller.GetBooks();

    // Assert
    var okResult = result.Result.Should().BeOfType<OkObjectResult>().Subject;
    var returnedBooks = okResult.Value.Should().BeOfType<List<BookDto>>().Subject;
    returnedBooks.Should().HaveCount(2);
}
```

#### GetBook_ReturnsOkResult_WhenBookExists
```csharp
[Fact]
public async Task GetBook_ReturnsOkResult_WhenBookExists()
{
    // Arrange
    var book = TestHelpers.CreateTestBookDto(1);
    _mockBookService.Setup(x => x.GetBookByIdAsync(1)).ReturnsAsync(book);

    // Act
    var result = await _controller.GetBook(1);

    // Assert
    var okResult = result.Result.Should().BeOfType<OkObjectResult>().Subject;
    var returnedBook = okResult.Value.Should().BeOfType<BookDto>().Subject;
    returnedBook.Id.Should().Be(1);
}
```

#### GetBook_ReturnsNotFound_WhenBookDoesNotExist
```csharp
[Fact]
public async Task GetBook_ReturnsNotFound_WhenBookDoesNotExist()
{
    // Arrange
    _mockBookService.Setup(x => x.GetBookByIdAsync(999)).ReturnsAsync((BookDto?)null);

    // Act
    var result = await _controller.GetBook(999);

    // Assert
    result.Result.Should().BeOfType<NotFoundObjectResult>();
}
```

### 2. POST Operations

#### CreateBook_ReturnsCreatedAtAction_WhenValidData
```csharp
[Fact]
public async Task CreateBook_ReturnsCreatedAtAction_WhenValidData()
{
    // Arrange
    var createDto = TestHelpers.CreateTestCreateBookDto();
    var createdBook = TestHelpers.CreateTestBookDto(1);
    _mockBookService.Setup(x => x.CreateBookAsync(createDto)).ReturnsAsync(createdBook);

    // Act
    var result = await _controller.CreateBook(createDto);

    // Assert
    var createdAtResult = result.Should().BeOfType<CreatedAtActionResult>().Subject;
    createdAtResult.Value.Should().BeOfType<BookDto>();
}

#### CreateBook_ReturnsBadRequest_WhenServiceThrowsArgumentException
```csharp
[Fact]
public async Task CreateBook_ReturnsBadRequest_WhenServiceThrowsArgumentException()
{
    // Arrange
    var createDto = TestHelpers.CreateTestCreateBookDto();
    _mockBookService.Setup(x => x.CreateBookAsync(createDto))
        .ThrowsAsync(new ArgumentException("Book with this title already exists"));

    // Act
    var result = await _controller.CreateBook(createDto);

    // Assert
    result.Should().BeOfType<BadRequestObjectResult>();
}
```

### 3. PUT Operations

#### UpdateBook_ReturnsNoContent_WhenValidData
```csharp
[Fact]
public async Task UpdateBook_ReturnsNoContent_WhenValidData()
{
    // Arrange
    var updateDto = TestHelpers.CreateTestUpdateBookDto();
    var updatedBook = TestHelpers.CreateTestBookDto(1);
    _mockBookService.Setup(x => x.UpdateBookAsync(1, updateDto)).ReturnsAsync(updatedBook);

    // Act
    var result = await _controller.UpdateBook(1, updateDto);

    // Assert
    result.Should().BeOfType<NoContentResult>();
}

#### UpdateBook_ReturnsNotFound_WhenBookDoesNotExist
```csharp
[Fact]
public async Task UpdateBook_ReturnsNotFound_WhenBookDoesNotExist()
{
    // Arrange
    var updateDto = TestHelpers.CreateTestUpdateBookDto();
    _mockBookService.Setup(x => x.UpdateBookAsync(999, updateDto))
        .ThrowsAsync(new ArgumentException("Book not found"));

    // Act
    var result = await _controller.UpdateBook(999, updateDto);

    // Assert
    result.Should().BeOfType<NotFoundObjectResult>();
}
```

### 4. DELETE Operations

#### DeleteBook_ReturnsNoContent_WhenBookExists
```csharp
[Fact]
public async Task DeleteBook_ReturnsNoContent_WhenBookExists()
{
    // Arrange
    _mockBookService.Setup(x => x.DeleteBookAsync(1)).ReturnsAsync(true);

    // Act
    var result = await _controller.DeleteBook(1);

    // Assert
    result.Should().BeOfType<NoContentResult>();
}

#### DeleteBook_ReturnsNotFound_WhenBookDoesNotExist
```csharp
[Fact]
public async Task DeleteBook_ReturnsNotFound_WhenBookDoesNotExist()
{
    // Arrange
    _mockBookService.Setup(x => x.DeleteBookAsync(999)).ReturnsAsync(false);

    // Act
    var result = await _controller.DeleteBook(999);

    // Assert
    result.Should().BeOfType<NotFoundObjectResult>();
}
```

### 5. Search and Filter Operations

#### GetBooksByPublisher_ReturnsOkResult_WithBooksList
```csharp
[Fact]
public async Task GetBooksByPublisher_ReturnsOkResult_WithBooksList()
{
    // Arrange
    var books = new List<BookDto>
    {
        TestHelpers.CreateTestBookDto(1),
        TestHelpers.CreateTestBookDto(2)
    };
    _mockBookService.Setup(x => x.GetBooksByPublisherAsync(1)).ReturnsAsync(books);

    // Act
    var result = await _controller.GetBooksByPublisher(1);

    // Assert
    var okResult = result.Result.Should().BeOfType<OkObjectResult>().Subject;
    var returnedBooks = okResult.Value.Should().BeOfType<List<BookDto>>().Subject;
    returnedBooks.Should().HaveCount(2);
    returnedBooks.Should().AllSatisfy(book => book.PublisherName.Should().Contain("Test Publisher"));
}
```

#### GetBooksByCategory_ReturnsOkResult_WithBooksList
```csharp
[Fact]
public async Task GetBooksByCategory_ReturnsOkResult_WithBooksList()
{
    // Arrange
    var books = new List<BookDto>
    {
        TestHelpers.CreateTestBookDto(1),
        TestHelpers.CreateTestBookDto(2)
    };
    _mockBookService.Setup(x => x.GetBooksByCategoryAsync(1)).ReturnsAsync(books);

    // Act
    var result = await _controller.GetBooksByCategory(1);

    // Assert
    var okResult = result.Result.Should().BeOfType<OkObjectResult>().Subject;
    var returnedBooks = okResult.Value.Should().BeOfType<List<BookDto>>().Subject;
    returnedBooks.Should().HaveCount(2);
    returnedBooks.Should().AllSatisfy(book => book.CategoryName.Should().Contain("Test Category"));
}
```

#### GetBooksByAuthor_ReturnsOkResult_WithBooksList
```csharp
[Fact]
public async Task GetBooksByAuthor_ReturnsOkResult_WithBooksList()
{
    // Arrange
    var books = new List<BookDto>
    {
        TestHelpers.CreateTestBookDto(1),
        TestHelpers.CreateTestBookDto(2)
    };
    _mockBookService.Setup(x => x.GetBooksByAuthorAsync(1)).ReturnsAsync(books);

    // Act
    var result = await _controller.GetBooksByAuthor(1);

    // Assert
    var okResult = result.Result.Should().BeOfType<OkObjectResult>().Subject;
    var returnedBooks = okResult.Value.Should().BeOfType<List<BookDto>>().Subject;
    returnedBooks.Should().HaveCount(2);
    returnedBooks.Should().AllSatisfy(book => book.AuthorName.Should().Contain("Test Author"));
}
```

## Key Testing Patterns

### 1. ActionResult<T> vs IActionResult
- **GET methods** return `ActionResult<T>` - use `.Result` property in assertions
- **POST/PUT/DELETE methods** return `IActionResult` - assert directly

### 2. Mock Setup Patterns
```csharp
// For Task<T> return types
_mockService.Setup(x => x.MethodAsync()).ReturnsAsync(expectedValue);

// For Task return types  
_mockService.Setup(x => x.MethodAsync()).Returns(Task.CompletedTask);

// For exception scenarios
_mockService.Setup(x => x.MethodAsync())
    .ThrowsAsync(new ArgumentException("Error message"));
```

### 3. Assertion Patterns
```csharp
// For ActionResult<T> methods
var okResult = result.Result.Should().BeOfType<OkObjectResult>().Subject;

// For IActionResult methods
result.Should().BeOfType<CreatedAtActionResult>();

// For collection assertions
returnedItems.Should().HaveCount(expectedCount);
returnedItems.Should().AllSatisfy(item => item.Property.Should().Contain("Expected"));
```

## Test Data Helpers

The tests use `TestHelpers` class for creating test data:

```csharp
// Create test DTOs
var book = TestHelpers.CreateTestBookDto(1);
var createDto = TestHelpers.CreateTestCreateBookDto();
var updateDto = TestHelpers.CreateTestUpdateBookDto();

// Create test entities
var bookEntity = TestHelpers.CreateTestBook(1);
```

## Best Practices

1. **Always examine controller code** before writing tests
2. **Use `.Result` property** for `ActionResult<T>` return types
3. **Match mock setups** to interface signatures exactly
4. **Test actual controller behavior**, not assumptions
5. **Use consistent naming** for test methods
6. **Group related tests** by operation type
7. **Test both success and failure scenarios**
8. **Verify service method calls** when appropriate

## Common Issues and Solutions

### Issue 1: ActionResult<T> Assertion Errors
```csharp
// ❌ Wrong
result.Should().BeOfType<OkObjectResult>();

// ✅ Correct
result.Result.Should().BeOfType<OkObjectResult>();
```

### Issue 2: Mock Setup Return Type Mismatch
```csharp
// ❌ Wrong
_mockService.Setup(x => x.MethodAsync()).Returns(Task.CompletedTask);

// ✅ Correct
_mockService.Setup(x => x.MethodAsync()).ReturnsAsync(expectedValue);
```

### Issue 3: Test Data Consistency
```csharp
// Test helpers create different names for each book
// Use Contains() instead of exact matching
returnedBooks.Should().AllSatisfy(book => book.AuthorName.Should().Contain("Test Author"));
```

This comprehensive test suite ensures the `BooksController` functions correctly under all scenarios and maintains high code quality standards. 