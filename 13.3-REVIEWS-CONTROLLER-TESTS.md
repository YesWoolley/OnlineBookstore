# Reviews Controller Tests

This document provides comprehensive unit tests for the `ReviewsController` in the Online Bookstore application.

## Test Structure

### Test Class Setup
```csharp
public class ReviewsControllerTests
{
    private readonly Mock<IReviewService> _mockReviewService;
    private readonly ReviewsController _controller;

    public ReviewsControllerTests()
    {
        _mockReviewService = new Mock<IReviewService>();
        _controller = new ReviewsController(_mockReviewService.Object);
    }
}
```

## Test Categories

### 1. GET Operations

#### GetReviews_ReturnsOkResult_WithReviewsList
```csharp
[Fact]
public async Task GetReviews_ReturnsOkResult_WithReviewsList()
{
    // Arrange
    var reviews = new List<ReviewDto>
    {
        TestHelpers.CreateTestReviewDto(1),
        TestHelpers.CreateTestReviewDto(2)
    };
    _mockReviewService.Setup(x => x.GetAllReviewsAsync()).ReturnsAsync(reviews);

    // Act
    var result = await _controller.GetReviews();

    // Assert
    var okResult = result.Result.Should().BeOfType<OkObjectResult>().Subject;
    var returnedReviews = okResult.Value.Should().BeOfType<List<ReviewDto>>().Subject;
    returnedReviews.Should().HaveCount(2);
}
```

#### GetReview_ReturnsOkResult_WhenReviewExists
```csharp
[Fact]
public async Task GetReview_ReturnsOkResult_WhenReviewExists()
{
    // Arrange
    var review = TestHelpers.CreateTestReviewDto(1);
    _mockReviewService.Setup(x => x.GetReviewByIdAsync(1)).ReturnsAsync(review);

    // Act
    var result = await _controller.GetReview(1);

    // Assert
    var okResult = result.Result.Should().BeOfType<OkObjectResult>().Subject;
    var returnedReview = okResult.Value.Should().BeOfType<ReviewDto>().Subject;
    returnedReview.Id.Should().Be(1);
}
```

#### GetReview_ReturnsNotFound_WhenReviewDoesNotExist
```csharp
[Fact]
public async Task GetReview_ReturnsNotFound_WhenReviewDoesNotExist()
{
    // Arrange
    _mockReviewService.Setup(x => x.GetReviewByIdAsync(999)).ReturnsAsync((ReviewDto?)null);

    // Act
    var result = await _controller.GetReview(999);

    // Assert
    result.Result.Should().BeOfType<NotFoundObjectResult>();
}
```

### 2. POST Operations

#### CreateReview_ReturnsCreatedAtAction_WhenValidData
```csharp
[Fact]
public async Task CreateReview_ReturnsCreatedAtAction_WhenValidData()
{
    // Arrange
    var createDto = TestHelpers.CreateTestCreateReviewDto();
    var createdReview = TestHelpers.CreateTestReviewDto(1);
    _mockReviewService.Setup(x => x.CreateReviewAsync("current-user-id", createDto)).ReturnsAsync(createdReview);

    // Act
    var result = await _controller.CreateReview(createDto);

    // Assert
    var createdAtResult = result.Should().BeOfType<CreatedAtActionResult>().Subject;
    createdAtResult.Value.Should().BeOfType<ReviewDto>();
}
```

#### CreateReview_ReturnsBadRequest_WhenServiceThrowsArgumentException
```csharp
[Fact]
public async Task CreateReview_ReturnsBadRequest_WhenServiceThrowsArgumentException()
{
    // Arrange
    var createDto = TestHelpers.CreateTestCreateReviewDto();
    _mockReviewService.Setup(x => x.CreateReviewAsync("current-user-id", createDto))
        .ThrowsAsync(new ArgumentException("Book not found"));

    // Act
    var result = await _controller.CreateReview(createDto);

    // Assert
    result.Should().BeOfType<NotFoundObjectResult>();
}
```

### 3. PUT Operations

#### UpdateReview_ReturnsNoContent_WhenValidData
```csharp
[Fact]
public async Task UpdateReview_ReturnsNoContent_WhenValidData()
{
    // Arrange
    var updateDto = TestHelpers.CreateTestUpdateReviewDto();
    var updatedReview = TestHelpers.CreateTestReviewDto(1);
    _mockReviewService.Setup(x => x.UpdateReviewAsync(1, "current-user-id", updateDto)).ReturnsAsync(updatedReview);

    // Act
    var result = await _controller.UpdateReview(1, updateDto);

    // Assert
    result.Should().BeOfType<NoContentResult>();
}
```

#### UpdateReview_ReturnsNotFound_WhenReviewDoesNotExist
```csharp
[Fact]
public async Task UpdateReview_ReturnsNotFound_WhenReviewDoesNotExist()
{
    // Arrange
    var updateDto = TestHelpers.CreateTestUpdateReviewDto();
    _mockReviewService.Setup(x => x.UpdateReviewAsync(999, "current-user-id", updateDto))
        .ThrowsAsync(new ArgumentException("Review not found"));

    // Act
    var result = await _controller.UpdateReview(999, updateDto);

    // Assert
    result.Should().BeOfType<NotFoundObjectResult>();
}
```

### 4. DELETE Operations

#### DeleteReview_ReturnsNoContent_WhenReviewExists
```csharp
[Fact]
public async Task DeleteReview_ReturnsNoContent_WhenReviewExists()
{
    // Arrange
    _mockReviewService.Setup(x => x.DeleteReviewAsync(1, "current-user-id")).ReturnsAsync(true);

    // Act
    var result = await _controller.DeleteReview(1);

    // Assert
    result.Should().BeOfType<NoContentResult>();
}
```

#### DeleteReview_ReturnsNotFound_WhenReviewDoesNotExist
```csharp
[Fact]
public async Task DeleteReview_ReturnsNotFound_WhenReviewDoesNotExist()
{
    // Arrange
    _mockReviewService.Setup(x => x.DeleteReviewAsync(999, "current-user-id")).ReturnsAsync(false);

    // Act
    var result = await _controller.DeleteReview(999);

    // Assert
    result.Should().BeOfType<NotFoundObjectResult>();
}
```

### 5. Specialized Operations

#### GetReviewsByBook_ReturnsOkResult_WithReviewsList
```csharp
[Fact]
public async Task GetReviewsByBook_ReturnsOkResult_WithReviewsList()
{
    // Arrange
    var reviews = new List<ReviewDto>
    {
        TestHelpers.CreateTestReviewDto(1),
        TestHelpers.CreateTestReviewDto(2)
    };
    _mockReviewService.Setup(x => x.GetReviewsByBookAsync(1)).ReturnsAsync(reviews);

    // Act
    var result = await _controller.GetReviewsByBook(1);

    // Assert
    var okResult = result.Result.Should().BeOfType<OkObjectResult>().Subject;
    var returnedReviews = okResult.Value.Should().BeOfType<List<ReviewDto>>().Subject;
    returnedReviews.Should().HaveCount(2);
}
```

#### HasUserReviewedBook_ReturnsOkResult_WithBoolean
```csharp
[Fact]
public async Task HasUserReviewedBook_ReturnsOkResult_WithBoolean()
{
    // Arrange
    _mockReviewService.Setup(x => x.HasUserReviewedBookAsync(1, "current-user-id")).ReturnsAsync(true);

    // Act
    var result = await _controller.HasUserReviewedBook(1);

    // Assert
    var okResult = result.Result.Should().BeOfType<OkObjectResult>().Subject;
    var returnedValue = okResult.Value.Should().BeOfType<bool>().Subject;
    returnedValue.Should().BeTrue();
}
```

## Key Testing Patterns

### 1. ActionResult<T> vs IActionResult
- **GET methods** return `ActionResult<T>` - use `.Result` property in assertions
- **POST/PUT/DELETE methods** return `IActionResult` - assert directly

### 2. Mock Setup Patterns
```csharp
// For Task<T> return types
_mockService.Setup(x => x.MethodAsync()).ReturnsAsync(expectedValue);

// For Task return types  
_mockService.Setup(x => x.MethodAsync()).Returns(Task.CompletedTask);

// For exception scenarios
_mockService.Setup(x => x.MethodAsync())
    .ThrowsAsync(new ArgumentException("Error message"));
```

### 3. Assertion Patterns
```csharp
// For ActionResult<T> methods
var okResult = result.Result.Should().BeOfType<OkObjectResult>().Subject;

// For IActionResult methods
result.Should().BeOfType<CreatedAtActionResult>();

// For collection assertions
returnedItems.Should().HaveCount(expectedCount);
returnedItems.Should().AllSatisfy(item => item.Property.Should().Contain("Expected"));
```

## Test Data Helpers

The tests use `TestHelpers` class for creating test data:

```csharp
// Create test DTOs
var review = TestHelpers.CreateTestReviewDto(1);
var createDto = TestHelpers.CreateTestCreateReviewDto();
var updateDto = TestHelpers.CreateTestUpdateReviewDto();

// Create test entities
var reviewEntity = TestHelpers.CreateTestReview(1);
```

## Best Practices

1. **Always examine controller code** before writing tests
2. **Use `.Result` property** for `ActionResult<T>` return types
3. **Match mock setups** to interface signatures exactly
4. **Test actual controller behavior**, not assumptions
5. **Use consistent naming** for test methods
6. **Group related tests** by operation type
7. **Test both success and failure scenarios**
8. **Verify service method calls** when appropriate

## Common Issues and Solutions

### Issue 1: ActionResult<T> Assertion Errors
```csharp
// ❌ Wrong
result.Should().BeOfType<OkObjectResult>();

// ✅ Correct
result.Result.Should().BeOfType<OkObjectResult>();
```

### Issue 2: Mock Setup Return Type Mismatch
```csharp
// ❌ Wrong
_mockService.Setup(x => x.MethodAsync()).Returns(Task.CompletedTask);

// ✅ Correct
_mockService.Setup(x => x.MethodAsync()).ReturnsAsync(expectedValue);
```

### Issue 3: Service Method Signature Mismatch
```csharp
// Controller expects userId parameter
_mockReviewService.Setup(x => x.CreateReviewAsync("current-user-id", createDto))
    .ReturnsAsync(createdReview);
```

This comprehensive test suite ensures the `ReviewsController` functions correctly under all scenarios and maintains high code quality standards. 