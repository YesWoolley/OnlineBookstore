# Authentication & Authorization Controller Tests

This document provides comprehensive unit tests for the `AuthController` and authorization functionality in the Online Bookstore application.

## Test Structure

### Test Class Setup
```csharp
public class AuthControllerTests
{
    private readonly Mock<IAuthService> _mockAuthService;
    private readonly AuthController _controller;

    public AuthControllerTests()
    {
        _mockAuthService = new Mock<IAuthService>();
        _controller = new AuthController(_mockAuthService.Object);
    }
}
```

## Test Categories

### 1. Registration Tests

#### Register_ReturnsOkResult_WhenValidData
```csharp
[Fact]
public async Task Register_ReturnsOkResult_WhenValidData()
{
    // Arrange
    var registerDto = TestHelpers.CreateTestRegisterDto();
    var authResult = TestHelpers.CreateTestAuthResultDto();
    _mockAuthService.Setup(x => x.RegisterAsync(registerDto)).ReturnsAsync(authResult);

    // Act
    var result = await _controller.Register(registerDto);

    // Assert
    var okResult = result.Result.Should().BeOfType<OkObjectResult>().Subject;
    var returnedAuthResult = okResult.Value.Should().BeOfType<AuthResultDto>().Subject;
    returnedAuthResult.Success.Should().BeTrue();
    returnedAuthResult.Token.Should().NotBeNullOrEmpty();
    returnedAuthResult.User.Should().NotBeNull();
}
```

#### Register_ReturnsBadRequest_WhenUserAlreadyExists
```csharp
[Fact]
public async Task Register_ReturnsBadRequest_WhenUserAlreadyExists()
{
    // Arrange
    var registerDto = TestHelpers.CreateTestRegisterDto();
    var authResult = new AuthResultDto
    {
        Success = false,
        Message = "User with this email already exists"
    };
    _mockAuthService.Setup(x => x.RegisterAsync(registerDto)).ReturnsAsync(authResult);

    // Act
    var result = await _controller.Register(registerDto);

    // Assert
    var badRequestResult = result.Result.Should().BeOfType<BadRequestObjectResult>().Subject;
    badRequestResult.Value.Should().NotBeNull();
}
```

### 2. Login Tests

#### Login_ReturnsOkResult_WhenValidCredentials
```csharp
[Fact]
public async Task Login_ReturnsOkResult_WhenValidCredentials()
{
    // Arrange
    var loginDto = TestHelpers.CreateTestLoginDto();
    var authResult = TestHelpers.CreateTestAuthResultDto();
    _mockAuthService.Setup(x => x.LoginAsync(loginDto)).ReturnsAsync(authResult);

    // Act
    var result = await _controller.Login(loginDto);

    // Assert
    var okResult = result.Result.Should().BeOfType<OkObjectResult>().Subject;
    var returnedAuthResult = okResult.Value.Should().BeOfType<AuthResultDto>().Subject;
    returnedAuthResult.Success.Should().BeTrue();
    returnedAuthResult.Token.Should().NotBeNullOrEmpty();
}
```

#### Login_ReturnsBadRequest_WhenInvalidCredentials
```csharp
[Fact]
public async Task Login_ReturnsBadRequest_WhenInvalidCredentials()
{
    // Arrange
    var loginDto = TestHelpers.CreateTestLoginDto();
    var authResult = new AuthResultDto
    {
        Success = false,
        Message = "Invalid username or password"
    };
    _mockAuthService.Setup(x => x.LoginAsync(loginDto)).ReturnsAsync(authResult);

    // Act
    var result = await _controller.Login(loginDto);

    // Assert
    var badRequestResult = result.Result.Should().BeOfType<BadRequestObjectResult>().Subject;
    badRequestResult.Value.Should().NotBeNull();
}
```

### 3. Token Management Tests

#### RefreshToken_ReturnsOkResult_WhenValidRefreshToken
```csharp
[Fact]
public async Task RefreshToken_ReturnsOkResult_WhenValidRefreshToken()
{
    // Arrange
    var refreshToken = "valid-refresh-token";
    var authResult = TestHelpers.CreateTestAuthResultDto();
    _mockAuthService.Setup(x => x.RefreshTokenAsync(refreshToken)).ReturnsAsync(authResult);

    // Act
    var result = await _controller.RefreshToken(refreshToken);

    // Assert
    var okResult = result.Result.Should().BeOfType<OkObjectResult>().Subject;
    var returnedAuthResult = okResult.Value.Should().BeOfType<AuthResultDto>().Subject;
    returnedAuthResult.Success.Should().BeTrue();
}
```

#### Logout_ReturnsOkResult_WhenValidRefreshToken
```csharp
[Fact]
public async Task Logout_ReturnsOkResult_WhenValidRefreshToken()
{
    // Arrange
    var refreshToken = "valid-refresh-token";
    _mockAuthService.Setup(x => x.LogoutAsync(refreshToken)).ReturnsAsync(true);

    // Act
    var result = await _controller.Logout(refreshToken);

    // Assert
    var okResult = result.Result.Should().BeOfType<OkObjectResult>().Subject;
    var returnedValue = okResult.Value.Should().NotBeNull();
}
```

### 4. Profile Management Tests

#### GetProfile_ReturnsOkResult_WhenUserIsAuthenticated
```csharp
[Fact]
public async Task GetProfile_ReturnsOkResult_WhenUserIsAuthenticated()
{
    // Arrange
    var userDto = TestHelpers.CreateTestUserDto();
    _mockAuthService.Setup(x => x.GetUserProfileAsync("current-user-id")).ReturnsAsync(userDto);

    // Act
    var result = await _controller.GetProfile();

    // Assert
    var okResult = result.Result.Should().BeOfType<OkObjectResult>().Subject;
    var returnedUser = okResult.Value.Should().BeOfType<UserDto>().Subject;
    returnedUser.Id.Should().Be("user-1");
}
```

#### UpdateProfile_ReturnsOkResult_WhenValidData
```csharp
[Fact]
public async Task UpdateProfile_ReturnsOkResult_WhenValidData()
{
    // Arrange
    var updateDto = TestHelpers.CreateTestUpdateProfileDto();
    var updatedUser = TestHelpers.CreateTestUserDto();
    _mockAuthService.Setup(x => x.UpdateProfileAsync("current-user-id", updateDto)).ReturnsAsync(updatedUser);

    // Act
    var result = await _controller.UpdateProfile(updateDto);

    // Assert
    var okResult = result.Result.Should().BeOfType<OkObjectResult>().Subject;
    var returnedUser = okResult.Value.Should().BeOfType<UserDto>().Subject;
    returnedUser.Id.Should().Be("user-1");
}
```

### 5. Password Management Tests

#### ChangePassword_ReturnsOkResult_WhenValidData
```csharp
[Fact]
public async Task ChangePassword_ReturnsOkResult_WhenValidData()
{
    // Arrange
    var changePasswordDto = TestHelpers.CreateTestChangePasswordDto();
    _mockAuthService.Setup(x => x.ChangePasswordAsync("current-user-id", changePasswordDto)).ReturnsAsync(true);

    // Act
    var result = await _controller.ChangePassword(changePasswordDto);

    // Assert
    var okResult = result.Result.Should().BeOfType<OkObjectResult>().Subject;
    okResult.Value.Should().NotBeNull();
}
```

#### ChangePassword_ReturnsBadRequest_WhenCurrentPasswordIsIncorrect
```csharp
[Fact]
public async Task ChangePassword_ReturnsBadRequest_WhenCurrentPasswordIsIncorrect()
{
    // Arrange
    var changePasswordDto = TestHelpers.CreateTestChangePasswordDto();
    _mockAuthService.Setup(x => x.ChangePasswordAsync("current-user-id", changePasswordDto))
        .ThrowsAsync(new InvalidOperationException("Current password is incorrect"));

    // Act
    var result = await _controller.ChangePassword(changePasswordDto);

    // Assert
    result.Result.Should().BeOfType<BadRequestObjectResult>();
}
```

## Key Testing Patterns

### 1. ActionResult<T> vs IActionResult
- **GET methods** return `ActionResult<T>` - use `.Result` property in assertions
- **POST/PUT/DELETE methods** return `IActionResult` - assert directly

### 2. Mock Setup Patterns
```csharp
// For Task<T> return types
_mockService.Setup(x => x.MethodAsync()).ReturnsAsync(expectedValue);

// For Task return types  
_mockService.Setup(x => x.MethodAsync()).Returns(Task.CompletedTask);

// For exception scenarios
_mockService.Setup(x => x.MethodAsync())
    .ThrowsAsync(new InvalidOperationException("Error message"));
```

### 3. Assertion Patterns
```csharp
// For ActionResult<T> methods
var okResult = result.Result.Should().BeOfType<OkObjectResult>().Subject;

// For IActionResult methods
result.Should().BeOfType<CreatedAtActionResult>();

// For anonymous type assertions
okResult.Value.Should().NotBeNull();
```

## Test Data Helpers

The tests use `TestHelpers` class for creating test data:

```csharp
// Create test DTOs
var registerDto = TestHelpers.CreateTestRegisterDto();
var loginDto = TestHelpers.CreateTestLoginDto();
var authResult = TestHelpers.CreateTestAuthResultDto();
var userDto = TestHelpers.CreateTestUserDto();
var updateProfileDto = TestHelpers.CreateTestUpdateProfileDto();
var changePasswordDto = TestHelpers.CreateTestChangePasswordDto();
```

## Best Practices

1. **Always examine controller code** before writing tests
2. **Use `.Result` property** for `ActionResult<T>` return types
3. **Match mock setups** to interface signatures exactly
4. **Test actual controller behavior**, not assumptions
5. **Use consistent naming** for test methods
6. **Group related tests** by operation type
7. **Test both success and failure scenarios**
8. **Verify service method calls** when appropriate

## Common Issues and Solutions

### Issue 1: ActionResult<T> Assertion Errors
```csharp
// ❌ Wrong
result.Should().BeOfType<OkObjectResult>();

// ✅ Correct
result.Result.Should().BeOfType<OkObjectResult>();
```

### Issue 2: Mock Setup Return Type Mismatch
```csharp
// ❌ Wrong
_mockService.Setup(x => x.MethodAsync()).Returns(Task.CompletedTask);

// ✅ Correct
_mockService.Setup(x => x.MethodAsync()).ReturnsAsync(expectedValue);
```

### Issue 3: Anonymous Type Assertions
```csharp
// ❌ Wrong
okResult.Value.Should().BeOfType<object>();

// ✅ Correct
okResult.Value.Should().NotBeNull();
```

This comprehensive test suite ensures the `AuthController` functions correctly under all scenarios and maintains high code quality standards. 