# Payment Testing Guide

This document provides comprehensive unit tests for the `PaymentsController` in the Online Bookstore application, focusing on PayPal integration testing.

## Test Structure

### Test Class Setup
```csharp
public class PaymentsControllerTests
{
    private readonly Mock<IPayPalService> _mockPayPalService;
    private readonly PaymentsController _controller;

    public PaymentsControllerTests()
    {
        _mockPayPalService = new Mock<IPayPalService>();
        _controller = new PaymentsController(_mockPayPalService.Object);
    }
}
```

## Test Categories

### 1. Success Operations

#### Success_ReturnsViewResult_WhenValidToken
```csharp
[Fact]
public async Task Success_ReturnsViewResult_WhenValidToken()
{
    // Arrange
    var token = "EC-123456789";
    var expectedOrder = new Order
    {
        Id = token,
        Status = "COMPLETED"
    };
    _mockPayPalService.Setup(x => x.CaptureOrder(token))
        .ReturnsAsync(expectedOrder);

    // Act
    var result = await _controller.Success(token);

    // Assert
    var viewResult = result.Should().BeOfType<ViewResult>().Subject;
    viewResult.Model.Should().Be(expectedOrder);
}
```

#### Success_ReturnsViewResult_WhenEmptyToken
```csharp
[Fact]
public async Task Success_ReturnsViewResult_WhenEmptyToken()
{
    // Arrange
    var token = "";
    var expectedOrder = new Order
    {
        Id = token,
        Status = "COMPLETED"
    };
    _mockPayPalService.Setup(x => x.CaptureOrder(It.IsAny<string>()))
        .ReturnsAsync(expectedOrder);

    // Act
    var result = await _controller.Success(token);

    // Assert
    var viewResult = result.Should().BeOfType<ViewResult>().Subject;
    viewResult.Model.Should().Be(expectedOrder);
}
```

#### Success_ReturnsViewResult_WhenNullToken
```csharp
[Fact]
public async Task Success_ReturnsViewResult_WhenNullToken()
{
    // Arrange
    string? token = null;
    var expectedOrder = new Order
    {
        Id = "",
        Status = "COMPLETED"
    };
    _mockPayPalService.Setup(x => x.CaptureOrder(It.IsAny<string>()))
        .ReturnsAsync(expectedOrder);

    // Act
    var result = await _controller.Success(token!);

    // Assert
    var viewResult = result.Should().BeOfType<ViewResult>().Subject;
    viewResult.Model.Should().Be(expectedOrder);
}
```

### 2. Exception Handling

#### Success_ThrowsException_WhenPayPalServiceThrowsException
```csharp
[Fact]
public async Task Success_ThrowsException_WhenPayPalServiceThrowsException()
{
    // Arrange
    var token = "EC-123456789";
    _mockPayPalService.Setup(x => x.CaptureOrder(token))
        .ThrowsAsync(new Exception("PayPal capture error"));

    // Act & Assert
    await _controller.Invoking(x => x.Success(token))
        .Should().ThrowAsync<Exception>()
        .WithMessage("PayPal capture error");
}
```

#### Success_ThrowsException_WhenInvalidToken
```csharp
[Fact]
public async Task Success_ThrowsException_WhenInvalidToken()
{
    // Arrange
    var token = "INVALID-TOKEN";
    _mockPayPalService.Setup(x => x.CaptureOrder(token))
        .ThrowsAsync(new ArgumentException("Invalid order token"));

    // Act & Assert
    await _controller.Invoking(x => x.Success(token))
        .Should().ThrowAsync<ArgumentException>()
        .WithMessage("Invalid order token");
}
```

### 3. Cancel Operations

#### Cancel_ReturnsViewResult
```csharp
[Fact]
public void Cancel_ReturnsViewResult()
{
    // Act
    var result = _controller.Cancel();

    // Assert
    result.Should().BeOfType<ViewResult>();
}
```

#### Cancel_ReturnsViewResult_WithNoModel
```csharp
[Fact]
public void Cancel_ReturnsViewResult_WithNoModel()
{
    // Act
    var result = _controller.Cancel();

    // Assert
    var viewResult = result.Should().BeOfType<ViewResult>().Subject;
    viewResult.Model.Should().BeNull();
}
```

### 4. Service Verification

#### Success_CallsPayPalServiceWithCorrectToken
```csharp
[Fact]
public async Task Success_CallsPayPalServiceWithCorrectToken()
{
    // Arrange
    var token = "EC-123456789";
    var expectedOrder = new Order { Id = token, Status = "COMPLETED" };
    _mockPayPalService.Setup(x => x.CaptureOrder(token))
        .ReturnsAsync(expectedOrder);

    // Act
    await _controller.Success(token);

    // Assert
    _mockPayPalService.Verify(x => x.CaptureOrder(token), Times.Once);
}
```

## Key Testing Patterns

### 1. Mock Setup Patterns
```csharp
// For Task<T> return types
_mockPayPalService.Setup(x => x.CaptureOrder(token))
    .ReturnsAsync(expectedOrder);

// For exception scenarios
_mockPayPalService.Setup(x => x.CaptureOrder(token))
    .ThrowsAsync(new Exception("Error message"));

// For verification
_mockPayPalService.Verify(x => x.CaptureOrder(token), Times.Once);
```

### 2. Exception Testing Patterns
```csharp
// Test that controller throws expected exception
await _controller.Invoking(x => x.Success(token))
    .Should().ThrowAsync<Exception>()
    .WithMessage("Expected error message");
```

### 3. Assertion Patterns
```csharp
// For ViewResult assertions
var viewResult = result.Should().BeOfType<ViewResult>().Subject;
viewResult.Model.Should().Be(expectedModel);

// For null model assertions
viewResult.Model.Should().BeNull();
```

## Test Data Helpers

The tests use `TestHelpers` class for creating test data:

```csharp
// Create test payment DTOs
var createPaymentDto = TestHelpers.CreateTestCreatePaymentDto();
var paymentResultDto = TestHelpers.CreateTestPaymentResultDto();
var paymentCaptureDto = TestHelpers.CreateTestPaymentCaptureDto();

// Create test PayPal Order
var order = new Order
{
    Id = "EC-123456789",
    Status = "COMPLETED"
};
```

## Best Practices

1. **Focus on core business logic** - avoid complex URL generation in tests
2. **Mock external services** - don't make real PayPal API calls in unit tests
3. **Test exception scenarios** - ensure proper error handling
4. **Verify service calls** - ensure correct parameters are passed
5. **Use consistent naming** for test methods
6. **Test edge cases** - null values, empty strings, invalid tokens
7. **Keep tests simple** - avoid complex setup that can break

## Common Issues and Solutions

### Issue 1: URL Generation Complexity
```csharp
// ❌ Avoid complex URL generation in unit tests
var successUrl = Url.Action("Success", "Payments", null, Request.Scheme);

// ✅ Focus on testing core business logic instead
// Test the PayPal service integration directly
```

### Issue 2: Extension Method Mocking
```csharp
// ❌ Extension methods cannot be mocked directly
urlHelper.Setup(x => x.Action(...)).Returns(...);

// ✅ Use custom implementations or focus on core logic
_controller.Url = new CustomUrlHelper();
```

### Issue 3: External Service Dependencies
```csharp
// ❌ Don't make real API calls in unit tests
var result = await _paypalService.CreateOrder(amount);

// ✅ Mock external services for isolated testing
_mockPayPalService.Setup(x => x.CreateOrder(amount))
    .ReturnsAsync("https://paypal.com/checkout");
```

## Testing Strategy

### 1. Unit Tests (Current Focus)
- Test controller logic in isolation
- Mock PayPal service dependencies
- Verify correct service method calls
- Test exception handling

### 2. Integration Tests (Future)
- Test with real PayPal sandbox environment
- Verify end-to-end payment flow
- Test actual API responses

### 3. End-to-End Tests (Future)
- Test complete payment workflow
- Verify database updates
- Test user experience flow

## PayPal Integration Notes

### Sandbox Environment
```csharp
// Use PayPal sandbox for testing
var sandboxClientId = "your-sandbox-client-id";
var sandboxSecret = "your-sandbox-secret";
```

### Test Data
```csharp
// Common test tokens
var validToken = "EC-123456789";
var invalidToken = "INVALID-TOKEN";
var emptyToken = "";
```

### Error Scenarios
```csharp
// Test various error conditions
- Invalid payment tokens
- Network timeouts
- PayPal service errors
- Invalid amounts
- Expired tokens
```

This comprehensive test suite ensures the `PaymentsController` functions correctly under all scenarios while maintaining proper separation of concerns and avoiding complex external dependencies in unit tests. 